<dom-module id="app-data">
	<template>
		<div class="jumbotron-w-image bg-inverse">
			<div class="breadcrumb-container">
				<div class="container">
					<ol class="breadcrumb">
						<li><a href="../../..">Home</a></li>
						<li><a href="../..">Portfolio</a></li>
						<li><a href="../home">Flota Ferroviaria</a></li>
						<li class="active" id="actual-line">Línea {{params.line}}</li>
					</ol>
				</div>
			</div>
			<div class="jumbotron">
				<div class="container" id="welcome-text">
					<h1>Cargando datos de la línea {{params.line}}...</h1>
					<p>Un poco por acá y un poquitito más por allá y ya estamos... </p>
				</div>
			</div>
		</div>
		<script>
			var lastModified; 

			function happyBrowsingChecker() {
				// Check for the various File API support.
				if (window.File && window.FileReader && window.FileList && window.Blob) {
					// Great success! All the File APIs are supported.
					$.ajax({
						type: "GET",
						url: "data/linea"+fileToHandle+".csv",
						dataType: "text",
						success: function(data, textStatus, request) {
							var title = $.map(rwJSON, function(value, key) {
								if (value.line == fileToHandle){
									return value.titlesection;
								}
							});
							var description = $.map(rwJSON, function(value, key) {
								if (value.line == fileToHandle){
									return value.description;
								}
							});
							var actualLine = $.map(rwJSON, function(value, key) {
								if (value.line == fileToHandle){
									return value.hometitle;
								}
							});
							$('li#actual-line').html(actualLine); 
							$('#welcome-text h1').html(title); 
							$('#welcome-text p').html(description); 
							$('.container#content').html('<h5>Última modificación: <span id="last-modified" title="No se pudo obtener la fecha de la última modificación.">sin especificar</span>.</h5>\
															<div class="table-responsive">\
																<table id="lineData" class="table table-inverse"></table>\
															</div>\
															<a class="btn btn-primary" href="data/linea'+fileToHandle+'.csv" target="api">Descargar CSV</a>');
							// Obtains last modified in UTC time
							lastModified = request.getResponseHeader("Last-Modified"); 
							// Subtract 3 hours to convert to UTC-3. 
							lastModMomJS = moment(lastModified, "ddd, DD MMM YYYY HH:mm:ss ZZ").subtract(3, 'hours'); 

							// Parses to human language. 
							parseToMoment = moment(lastModMomJS).locale('es').format("dddd DD/MM/YY [a las] hh:mma");
	    					fromNowMomJS = moment(lastModMomJS, "ddd, DD MMM YYYY HH:mm:ss ZZ").utcOffset('-0600').locale('es').fromNow(true);

	  						// Shows data on the site. 
							$('#last-modified').html('hace ' + fromNowMomJS).attr('data-toggle', "tooltip").attr('data-placement', "top").attr('title', 'Modificado el ' + parseToMoment); 
							csvData = data; 
							printTable();
						},
						error: function(textStatus){
							$('#welcome-text h1').html("Próximamente podrás ver la flota de esta línea"); 
							$('#welcome-text p').html("De todas formas te invito a que revises los demás datasets publicados. "); 
							console.log(textStatus); 
							$('.container#content').html('<h1>Aún no se cargó información de esta línea.</h1><p>Volvé en otro momento o visitá el dataset de las líneas cargadas. </p>')
						}
					});
					return true;
				} else {
					// source: File API availability - http://caniuse.com/#feat=fileapi
					// source: <output> availability - http://html5doctor.com/the-output-element/
					document.writeln('Para poder ver la información cargada en el sitio tenés que entrar con alguno de estos browsers: <br />');
					// 6.0 File API & 13.0 <output>
					document.writeln(' - Google Chrome: 13.0 o superior<br />');
					// 3.6 File API & 6.0 <output>
					document.writeln(' - Mozilla Firefox: 6.0 o superior<br />');
					// 10.0 File API & 10.0 <output>
					document.writeln('Estos browsers no son soportados: <br />');
					document.writeln(' - Internet Explorer (Por dios, si usás este no lo usés más). <br />');
					// ? File API & 5.1 <output>
					document.writeln(' - Safari<br />');
					// ? File API & 9.2 <output>
					document.writeln(' - Opera');
					return false;
				}
			}
			
			function printTable(file) {
				//console.log(csvData); 
				var data = $.csv.toArrays(csvData);
				var html = '';
				for(var row in data) {
					if (row == 0){
						html += '<thead>\r\n';
					}
					html += '<tr>\r\n';
					//alert(row); 
					for(var item in data[row]) {
						if (row == 0){
							html += '<th>' + data[row][item] + '</th>\r\n';
						} else {
							html += '<td>' + data[row][item] + '</td>\r\n';
						};
						//html += '<td>' + data[row][item] + '</td>\r\n';
					}
					html += '</tr>\r\n';
					if (row == 0){
						html += '</thead>\r\n<tbody>\r\n';
					}
				}
				$('#lineData').html(html);
				$(function () {$('[data-toggle="tooltip"]').tooltip()})
			}
		</script>
		<div class="container" id="content">
			<h1>Cargando...</h1>
		</div>
	</template>
	<script>
		var blocks = [subway = '', railway = '']; 
		Polymer({
			is: "app-data", 
			properties: {
				subwayLines: {
					type: String
				},
				railwayLines: {
					type: String
				}
			}, 
			type: function (data) {
				if (data === "subway") {
					return true;
				} else if (data === "railway") {
					return false; 
				}
			}
		});
	</script>
</dom-module>